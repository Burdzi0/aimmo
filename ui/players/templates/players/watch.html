{% extends 'players/base.html' %}

{% block content %}
<span id="watch-world-canvas"></span>
{% endblock %}

{% block additionalHeaderStyles %}
<link rel="stylesheet" type="text/css" href="/static/css/watch.css"/>
{% endblock %}

{% block additionalHeaderScripts %}
<script type="text/javascript" src="/static/js/lib/raphael-min.js"></script>
<script type="text/javascript" src="/static/js/watch/world-viewer.js"></script>
<script type="text/javascript" src="/static/js/watch/world-model.js"></script>
<script type="text/javascript" src="/static/js/watch/world-controls.js"></script>
{% endblock %}

{% block scripts %}
<script type="text/javascript">
    VIEWER.init(document.getElementById("watch-world-canvas"), WORLD, APPEARANCE);
    CONTROLS.init(WORLD, VIEWER);

    function refreshWorld() {
        console.log("Refreshing world...");
        jQuery.ajax("/api/watch/world", {
            ____timeout : 500,
            success : function(data) {
                CONTROLS.initialiseWorld(data.width, data.height, data.layout);
                console.log("World refresh successful.");

                console.log("Refreshing state...");
                refreshState()
            },
            error : function(jqXHR, textStatus, errorThrown) {
                console.error("World refresh failed.", jqXHR, textStatus, errorThrown);
                setTimeout(refreshWorld, 500);
            }
        });
    }

    function refreshState() {
        jQuery.ajax("/api/watch/state", {
            complete : function(jqXHR, textStatus) {
                setTimeout(refreshState, 100);
            },
            success : function(data) {
                CONTROLS.setState(data.players, data.items);
            },
            error : function(jqXHR, textStatus, errorThrown) {
                console.error("State refresh failed.", jqXHR, textStatus, errorThrown);
                setTimeout(refreshState, 500);
            }
        });
    }

    refreshWorld();
</script>
{% endblock %}